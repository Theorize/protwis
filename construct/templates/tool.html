{% extends "home/base.html" %}
{% load staticfiles %}
{% block content %}
  <style>
  .ui-menu { width: 200px; }
  .ui-widget-header { padding: 0.2em; }
  </style>

<div class="modal bd-example-modal-lg" id="myModal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
      </div>
      <div class="modal-body" id="ModalBody">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<h2> Construct Design Tool  </h2>
<p>
Target: {{target.entry_name}}
</p>

<div id="dialog" title="Reset">
  <p>You sure you want to reset this construct?</p>
</div>

State: <div class="btn-group" data-toggle="buttons">
  <label class="btn btn-default active">
    <input type="radio" name="state" value="inactive" checked=""> Inactive
  </label>
  <label class="btn btn-default">
    <input type="radio" name="state" value="active"> Active
  </label>
</div>
Fusion Site: <div class="btn-group" data-toggle="buttons">
  <label class="btn btn-default">
    <input type="radio" name="fusionpos" value="nterm"> N-term
  </label>
  <label class="btn btn-default active">
    <input type="radio" name="fusionpos" value="icl3" checked=""> ICL3
  </label>
  <label class="btn btn-default">
    <input type="radio" name="fusionpos" value="None"> None
  </label>
</div>
<button class="btn btn-warning" onclick='$( "#dialog" ).dialog( "open" )''>Reset</button>
<button class="btn btn-info" onclick='exportCSVsuggestions();'>Export all suggestions to CSV</button>
<br>
<br>
<div class="row">
  <div class="col-sm-2">
  Truncation suggestions:
  </div>
  <div class="col-sm-8">
    <button type="button" id="nterm_button" class="btn btn-primary" onclick='$("#myModalLabel").html("N-term");$("#ModalBody").html(tables["nterm"]);$("#myModal").modal("show");'>
      N-term
    </button>
    <button type="button" id="icl3_button" class="btn btn-primary" onclick='$("#myModalLabel").html("ICL3");$("#ModalBody").html(tables["icl3"]);$("#myModal").modal("show");'>
      ICL3
    </button>
    <button type="button" id="cterm_button" class="btn btn-primary" onclick='$("#myModalLabel").html("C-term");$("#ModalBody").html(tables["cterm"]);$("#myModal").modal("show");'>
      C-term
    </button>
  </div>
</div>
<div class="row">
  <div class="col-sm-2">
  Mutations:
  </div>
  <div class="col-sm-8">
    <button type="button" id="mutations_button" class="btn btn-primary" onclick='build_mutations();$("#myModalLabel").html("Thermostabilisation");$("#ModalBody").html(tables["mutations"]);$("#myModal").modal("show");'>
      Thermostabilisation
    </button>
    <button type="button" id="removals_button" class="btn btn-primary" onclick='build_site_removals();$("#myModalLabel").html("Site Removal");$("#ModalBody").html(tables["site_removals"]);$("#myModal").modal("show");'>
      Site Removal
    </button>
  </div>
</div>
<div class="row">
  <!-- <div class="col-sm-3">


    Truncation suggestions:<br>
        <div class="btn-group-vertical btn-block">
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle pull-right btn-block" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    N-term <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='ntermmenu'>
                <li>Loading...</li>
                </ul>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle pull-right" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    ICL3 <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='icl3menu'>
                <li>Loading...</li>
                </ul>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    C-term <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='ctermmenu'>
                <li>Loading...</li>
                </ul>
            </div>
        </div>

    Receptor specific:<br>
        <div class="btn-group-vertical btn-block">
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle pull-right" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Glycosylation site removal<span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='glyco'>
                <li>Loading...</li>
                </ul>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle pull-right" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Palmitoylation site removal<span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='palmi'>
                <li>Loading...</li>
                </ul>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle pull-right btn-block" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                   Thermostabilisation <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='thermo'>
                <li>Loading...</li>
                </ul>
            </div>
        </div>
      Consensus analysis:<br>
        <div class="btn-group-vertical btn-block">
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle pull-right btn-block" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                   Xtal conservation in class <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='cons_strucs'>
                <li>Loading...</li>
                </ul>
            </div>
             <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle pull-right btn-block" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                   Cons. in Receptor Family <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='cons_rf'>
                <li>Loading...</li>
                </ul>
            </div>
             <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle pull-right btn-block" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                   Cons. in Receptor Family&Class <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='cons_rf_and_class'>
                <li>Loading...</li>
                </ul>
            </div>
             <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle pull-right btn-block" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                   Remove G/P to cons. in RF <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id='cons_rm_GP'>
                <li>Loading...</li>
                </ul>
            </div>
        </div>

  </div> -->
  <div class="col-sm-12">
  {{ target.get_snake_plot_no_buttons }}
  </div>
</div>
<div class="row">
  <div class="col-sm-12">
    <div id="overview">
    </div>
  </div>
</div>
<iframe id="my_iframe" style="display:none;"></iframe>
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
    <script src="{% static 'home/js/diagrams.js' %}"></script> 
    <script type="text/javascript" charset="utf-8">

    var modifications = new Array;
    var tables = new Array;
    var mutations_browser = new Array;
    var removals_list = new Array;
    var export_list = {};
    export_list['nterm'] = [];
    export_list['cterm'] = [];
    export_list['icl3'] = [];
    export_list['thermo'] = [];
    export_list['removals'] = [];


    function resetAll() {
      modifications = new Array;
      resetModifications();
      modifications_overview();
    }

    function resetModifications() {

      $('#snakeplot').find("circle").each(function( index ){
            //console.log( index + ": " + $( this ).text() );
            aa =  $(this).next().text();
            //console.log( index + ": " + aa );
            $(this).css("fill", 'white');
            $(this).next().css("fill", 'black');
          });

    }

  function getSortedKeys(obj) {
      var keys = []; for(var key in obj) keys.push(key);
      return keys.sort(function(a,b){return obj[b]['hits']-obj[a]['hits']});
  }

  function exportCSVsuggestions(){

    // var data = [["name1", "city1", "some other info"], ["name2", "city2", "more info"]];
    // var csvContent = "data:text/csv;charset=utf-8,";
    console.log(export_list);
    // export_list.forEach(function(infoArray, index){

    //    //dataString = infoArray.join("'\t'");
    //    dataString = infoArray.join("','");
    //    csvContent += "'"+dataString+ "'\n";

    // }); 
    // var encodedUri = encodeURI(csvContent);
    // var link = document.createElement("a");
    // link.setAttribute("href", encodedUri);
    // link.setAttribute("download", "construct_suggestins_{{target.entry_name}}.csv");
    // document.body.appendChild(link); // Required for FF

    // link.click(); // This will download the data file named "my_data.csv".
    postData = JSON.stringify(export_list);
    //postData = [];
    
    // document.getElementById('my_iframe').src = "/common/exportexcel";

    console.log(postData)
    $.ajax({
      type:    "POST",
      url:     "/common/exportexcel",
      data:    {"d":postData},
      success: function(data) {
            console.log(data);
            console.log("/common/exportexceldownload/" + data+ "/{{target.entry_name}}");
            $("body").append("<iframe src='/common/exportexceldownload/" + data+ "/{{target.entry_name}}' style='display: none;' ></iframe>");
      },
      // vvv---- This is the new bit
      error:   function(jqXHR, textStatus, errorThrown) {
            alert("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown
            );
            console.log("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown);
      }
    });

    // $.post('/common/exportexcel', postData, function(retData) {
    //   console.log('hi');
    //   //$("body").append("<iframe src='" + retData.url+ "' style='display: none;' ></iframe>");
    //       var blob=new Blob([retData]);
    //       var link=document.createElement('a');
    //       link.href=window.URL.createObjectURL(blob);
    //       link.download="myFileName.xls";
    //       link.click();
    // }); 
  }

  function getSortedKeys_advanced(obj) {

    var keys = []; for(var key in obj) keys.push(key);
    return keys.sort(function(a,b){
      if (obj[a]['levels_num'][0] < obj[b]['levels_num'][0]) return 1;
      if (obj[a]['levels_num'][0] > obj[b]['levels_num'][0]) return -1;

      if (obj[a]['levels_num'][1] < obj[b]['levels_num'][1]) return 1;
      if (obj[a]['levels_num'][1] > obj[b]['levels_num'][1]) return -1;

      if (obj[a]['levels_num'][2] < obj[b]['levels_num'][2]) return 1;
      if (obj[a]['levels_num'][2] > obj[b]['levels_num'][2]) return -1;

      if (obj[a]['levels_num'][3] < obj[b]['levels_num'][3]) return 1;
      if (obj[a]['levels_num'][3] > obj[b]['levels_num'][3]) return -1;
      return 0;
    });
  }

    function build_nterm_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_nterm = {};
      show_table = {};
      level_num = 0
      $.each(n_term_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[3]) {
              if (fusionpos==vals[4] || (fusionpos=='None' && vals[4]!='nterm') || (fusionpos!='nterm' && vals[4]=='None') || 1==1) { //include all data regardless of fusion
                find = 1;
                // console.log(state +" "+fusionpos+" "+level+" "+protein+" "+pdb+" "+vals);
                if(!show_nterm[level]) { show_nterm[level] = {}; } 
                if(!show_nterm[level][vals[2]]) { show_nterm[level][vals[2]] = {'proteins': [],'pdbs': [], 'hits':0}; } 
                if(show_nterm[level][vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_nterm[level][vals[2]]['proteins'].push(protein);
                  show_nterm[level][vals[2]]['pdbs'].push(pdb);
                  show_nterm[level][vals[2]]['hits'] += 1;
                }

                // TABLE
                if(!show_table[vals[2]]) { show_table[vals[2]] = {'gn': vals[2], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0}; }

                if(show_table[vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_table[vals[2]]['proteins'].push(protein);
                  show_table[vals[2]]['pdbs'].push(pdb);
                  show_table[vals[2]]['hits'] += 1;
                  show_table[vals[2]]['levels_num'][level_num] += 1;
                }

                if(show_table[vals[2]]['levels'].indexOf(level)==-1) {
                  show_table[vals[2]]['levels'].push(level);
                }
              }
            }
          })
        })
        if (find==1 ){
          show_nterm[level]['sortedkeys'] = getSortedKeys(show_nterm[level]);
        }
        level_num += 1;
      }) 
      var items = [];
      $.each( show_nterm, function( key, val ) {
        temp = "<li id='" + key + "' class=\"dropdown-submenu\"><a href='#'>" + key + " ("+Object.keys(val).length+")</a><ul class=\"dropdown-menu\">";

        $.each( val['sortedkeys'], function( i, pos ) {
          val2 = show_nterm[key][pos];
          temp += "<li id='" + pos + "' class=\"dropdown-submenu\"><a href='#'>" + pos + " pos from 1x50 ("+val2['hits']+")</a><ul class=\"dropdown-menu\">";
          $.each( val2['proteins'], function( i, protein ) {
               pdb = val2['pdbs'][i];
              temp += "<li id='"+pdb+"'><a href='#' onclick='nterm_tm1(this)' value='"+pos+"' from='"+pdb+"'>"+protein+" ("+pdb+") "+pos+" pos from 1x50</a></li>";
          });
          temp += "</ul></li>";
        });
        temp += "</ul></li>";
        items.push( temp );
      });
      result = items.join( "" );
      $("#ntermmenu").html(result);

      var items_table = ["<table class='table-striped table table-bordered'><thead><tr><th>From 1.50</th><th>Hits</th><th>Levels</th><th>Use</th></tr></thead><tbody>"];
      $.each( getSortedKeys_advanced(show_table), function( i, pos ) {
        val = show_table[pos];
        temp = "<tr><td>1x"+(50-parseInt(pos))+"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td><a href='#' onclick='nterm_tm1(this)' value='"+pos+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['nterm'].push(["1x"+(50-parseInt(pos)),val['hits'],val['levels']])
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['nterm'] = result;
      $("#nterm_button").html("N-term ("+Object.keys(show_table).length+")");
      // $("#ModalBody").html(result);
    }

    function build_cterm_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_cterm = {};
      show_table = {};
      level_num = 0
      $.each(c_term_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[3]) {
                find = 1;
                // console.log(state +" "+fusionpos+" "+level+" "+protein+" "+pdb+" "+vals);
                if(!show_cterm[level]) { show_cterm[level] = {}; } 
                if(!show_cterm[level][vals[2]]) { show_cterm[level][vals[2]] = {'proteins': [],'pdbs': [], 'hits':0}; } 
                if(show_cterm[level][vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_cterm[level][vals[2]]['proteins'].push(protein);
                  show_cterm[level][vals[2]]['pdbs'].push(pdb);
                  show_cterm[level][vals[2]]['hits'] += 1;
                }

                // TABLE
                if(!show_table[vals[2]]) { show_table[vals[2]] = {'gn': vals[2], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0}; }

                if(show_table[vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_table[vals[2]]['proteins'].push(protein);
                  show_table[vals[2]]['pdbs'].push(pdb);
                  show_table[vals[2]]['hits'] += 1;
                  show_table[vals[2]]['levels_num'][level_num] += 1;
                }

                if(show_table[vals[2]]['levels'].indexOf(level)==-1) {
                  show_table[vals[2]]['levels'].push(level);
                }
            }
          })
        })
        if (find==1 ){
          show_cterm[level]['sortedkeys'] = getSortedKeys(show_cterm[level]);
        }
        level_num += 1;
      }) 

      var items = [];
      $.each( show_cterm, function( key, val ) {
        temp = "<li id='" + key + "' class=\"dropdown-submenu\"><a href='#'>" + key + " ("+Object.keys(val).length+")</a><ul class=\"dropdown-menu\">";

        $.each( val['sortedkeys'], function( i, pos ) {
          val2 = show_cterm[key][pos];
          temp += "<li id='" + pos + "' class=\"dropdown-submenu\"><a href='#'>" + pos + " pos from 8x50 ("+val2['hits']+")</a><ul class=\"dropdown-menu\">";
           $.each( val2['proteins'], function( i, protein ) {
               pdb = val2['pdbs'][i];
              temp += "<li id='"+pdb+"'><a href='#' onclick='cterm(this)' value='"+pos+"' from='"+pdb+"'>"+protein+" ("+pdb+") "+pos+" pos from 8x50</a></li>";
          });
          temp += "</ul></li>";
        });
        temp += "</ul></li>";
        items.push( temp );
      });
      result = items.join( "" );
      $("#ctermmenu").html(result);

      var items_table = ["<table class='table-striped table table-bordered'><thead><tr><th>From 8.50</th><th>Hits</th><th>Levels</th><th>Use</th></tr></thead><tbody>"];
      $.each( getSortedKeys_advanced(show_table), function( i, pos ) {
        val = show_table[pos];
        temp = "<tr><td>8x"+(parseInt(pos)+50)+"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td><a href='#' onclick='cterm(this)' value='"+pos+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['cterm'].push(["8x"+(parseInt(pos)+50),val['hits'],val['levels']])
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['cterm'] = result;
      $("#cterm_button").html("C-term ("+Object.keys(show_table).length+")");

    }

    function build_icl3_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_icl3 = {};
      show_table = {};
      level_num = 0
      $.each(icl3_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[2]) {
              if (fusionpos==vals[3] || (fusionpos=='None' && vals[3]!='icl3') || (fusionpos!='icl3' && vals[3]=='None')) {
                find = 1;
                range = "5."+(50+vals[0])+"-"+"6."+(50-vals[1]);

                if(!show_icl3[level]) { show_icl3[level] = {}; } 
                if(!show_icl3[level][range]) { show_icl3[level][range] = {'start': vals[0], 'end': vals[1], 'proteins': [],'pdbs': [], 'hits':0}; } 
                if(show_icl3[level][range]['proteins'].indexOf(protein)==-1) {
                  show_icl3[level][range]['proteins'].push(protein);
                  show_icl3[level][range]['pdbs'].push(pdb);
                  show_icl3[level][range]['hits'] += 1;
                }

                // TABLE
                if(!show_table[range]) { show_table[range] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0}; }

                if(show_table[range]['proteins'].indexOf(protein)==-1) {
                  show_table[range]['proteins'].push(protein);
                  show_table[range]['pdbs'].push(pdb);
                  show_table[range]['hits'] += 1;
                  show_table[range]['levels_num'][level_num] += 1;
                }

                if(show_table[range]['levels'].indexOf(level)==-1) {
                  show_table[range]['levels'].push(level);
                }

              }
            }
          })
        })
        if (find==1 ){
          show_icl3[level]['sortedkeys'] = getSortedKeys(show_icl3[level]);
        }
        level_num += 1;
      }) 

      var items = [];
      $.each( show_icl3, function( key, val ) {
        temp = "<li id='" + key + "' class=\"dropdown-submenu\"><a href='#'>" + key + " ("+Object.keys(val).length+")</a><ul class=\"dropdown-menu\">";

        $.each( val['sortedkeys'], function( i, pos ) {
          val2 = show_icl3[key][pos];
          temp += "<li id='" + pos + "' class=\"dropdown-submenu\"><a href='#'>" + pos + " ("+val2['hits']+")</a><ul class=\"dropdown-menu\">";
          $.each( val2['proteins'], function( i, protein ) {
               pdb = val2['pdbs'][i];
              range1 = "5."+(50+val2['start']);
              range2 = "6."+(50-val2['end']);
              temp += "<li id='"+pdb+"'><a href='#' onclick='icl3(this)'  tm5='"+val2['start']+"'  tm6='"+val2['end']+"' from='"+pdb+"'>"+protein+" ("+pdb+") "+range1+"-"+range2+"</a></li>";
          });
          temp += "</ul></li>";
        });
        temp += "</ul></li>";
        items.push( temp );
      });
      result = items.join( "" );
      $("#icl3menu").html(result);

      var items_table = ["<table class='table-striped table table-bordered'><thead><tr><th>Range</th><th>Hits</th><th>Levels</th><th>Use</th></tr></thead><tbody>"];
      $.each( getSortedKeys_advanced(show_table), function( i, pos ) {
        val = show_table[pos];
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td><a href='#' onclick='icl3(this)' tm5='"+val['start']+"'  tm6='"+val['end']+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['icl3'].push([pos,val['start'],val['end'],val['hits'],val['levels']])
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl3'] = result;
      $("#icl3_button").html("ICL3 ("+Object.keys(show_table).length+")");
    }

    function build_mutations() {
      console.log(mutations_browser);
      console.log(mutations_browser.length);
      var keys = Object.keys(mutations_browser);
      muts = {}
      $.each(keys, function( i,type ) {
        $.each(mutations_browser[type], function(gn, values){
          if(!muts[gn]) { muts[gn] = {'gn': gn, 'types': [], 'hits':0, 'details':[]}; }

          muts[gn]['hits'] += 1;
          muts[gn]['types'].push(type)
          muts[gn]['details'].push(values)
        });
      });
      console.log(muts);
        var items_table = ["<table class='table-striped table table-bordered'><thead><tr><th>Position</th><th>Mutation</th><th>Hits</th><th>Levels</th></tr></thead><tbody>"];
      $.each( getSortedKeys(muts), function( i, gn ) {
        vals = muts[gn];
        mut_suggestions = [];
        check = []
        label = []
        $.each(vals['details'], function(i, val) {
            console.log(val);
            if (vals['types'][i].substring(0, 5) == "cons_") {
              label.push(val[0]+val[1]+val[2]);
              if ($.inArray(val[0]+val[1]+val[2], check)==-1) {
                mut_suggestions.push("<a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' >"+val[0]+val[1]+val[2]+"</a>");
                check.push(val[0]+val[1]+val[2]);
              }
            } else if (vals['types'][i].substring(0, 5) == "termo") {
              $.each( val, function( key, value ) {
                if (vals['types'][i]=='termo_Common mutation (Wt)') {
                  console.log(key);
                  console.log(value);
                  $.each(value['muts'], function(i, mut_aa) {
                    console.log(mut_aa);
                    label.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    if ($.inArray(value['wt'][0]+value['wt'][1]+mut_aa, check)==-1) {
                      mut_suggestions.push("<a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+mut_aa+"'>"+value['wt'][0]+value['wt'][1]+mut_aa+"</a>");
                      check.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    }
                   });
                } else {
                    // temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+to+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+to+"</strong></a></li>";

                  label.push(value['wt'][0]+value['wt'][1]+key);
                  if ($.inArray(value['wt'][0]+value['wt'][1]+key, check)==-1) {
                    mut_suggestions.push("<a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+key+"'>"+value['wt'][0]+value['wt'][1]+key+"</a>");
                    check.push(value['wt'][0]+value['wt'][1]+key);
                  }
                }
              });

            }
        });
        temp = "<tr><td>"+gn+"</td><td>"+mut_suggestions.join(", ")+"</td><td>"+vals['hits']+"</td><td>"+vals['types']+"</td><td></tr>";
        items_table.push( temp );
        export_list['thermo'].push([gn,label.join(", "),val['hits'],val['types']]);
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['mutations'] = result;
      $("#mutations_button").html("Thermostabilisation ("+Object.keys(muts).length+")");
    }

    function build_site_removals() {
      var keys = Object.keys(removals_list);
      removals = {}
      count = 0;
      var items_table = ["<table class='table-striped table table-bordered'><thead><tr><th>Segment</th><th>Mutation</th><th>Type of removal</th></tr></thead><tbody>"];
      $.each(keys, function( i,type ) {
        $.each(removals_list[type], function(subtype, values){
          console.log(type);
          console.log(subtype);
          $.each(values, function(i, details) { 
            console.log(i);
            console.log(details);
            count += 1;
            if (details[2]!="") { //single mutation
              suggestion = "<a onclick='glyco(this)' motif='"+details[4]+"' pos='"+details[0]+"' wt='"+details[4][0]+"' from='"+details[4][0]+"' to='"+details[1]+"' to2='"+details[3]+"' wt2='"+details[4][1]+"'> Mutate "+details[4][0]+details[0]+details[1]+" & "+details[4][1]+parseInt(details[0]+1)+details[3]+"</a>";
              label = "Mutate "+details[4][0]+details[0]+details[1]+" & "+details[4][1]+parseInt(details[0]+1)+details[3];
            } else {
                suggestion =  "<a onclick='glyco(this)' motif='"+details[4]+"' pos='"+details[0]+"' wt='"+details[4][0]+"' from='"+details[4][0]+"' to='"+details[1]+"' > Mutate "+details[4][0]+details[0]+details[1]+"</a>";
                label = "Mutate "+details[4][0]+details[0]+details[1];
            }
            temp = "<tr><td>"+details[5]+"</td><td>"+suggestion+"</td><td>"+type+" ("+subtype+")</td><td></tr>";
            items_table.push( temp );
            export_list['removals'].push([details[5],label,type,subtype]);
          });
        });
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['site_removals'] = result;
      $("#removals_button").html("Site removals ("+count+")");
    }

    // ON CLICK FUNCTIONS

    function nterm_tm1(elem) {
      n_val = $(elem).attr("value");
      from = $(elem).attr("from");
      until = {{residues_gn.1x50.sequence_number}}-n_val;

      console.log(n_val+" "+until);

      range = new Array;
      for (var i = 1; 1 > 0 ? i <= until : i > until; i += 1) {
          range.push(i);
      }

      $('#myModal').modal('hide');
      modi = {method: "n-term", type: "deletion", from: from, range: range, info: "Based on "+from};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }

    function cterm(elem) {
      n_val = $(elem).attr("value");
      from = $(elem).attr("from");
      start = {{residues_gn.8x50.sequence_number}}-n_val;
      // start = {{residues.Cterm.0.sequence_number}}-n_val;
      {% with residues.Cterm|last as last %}
       end =   {{ last.sequence_number }};
      {% endwith %}

      range = new Array;
      for (var i = start; 1 > 0 ? i <= end : i > end; i += 1) {
          range.push(i);
      }


      modi = {method: "c-term", type: "deletion", from: from, range: range, info: "Based on "+from};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }

    function icl3(elem) {
      from = $(elem).attr("from");

      end = {{residues_gn.6x50.sequence_number}}-$(elem).attr("tm6");
      start = {{residues_gn.5x50.sequence_number}}-(-$(elem).attr("tm5"));
      console.log(start+" "+end);

      range = new Array;
      for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
          range.push(i);
      }


      modi = {method: "ICL3", type: "deletion", from: from, range: range, info: "Based on "+from};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }


    function mut(elem) {
      gn = $(elem).attr("gn");
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");

      origin = $(elem).parent().parent().parent().find('.origin').html();

      console.log(origin);

      range = new Array;
      range.push(pos);


      modi = {method: wt+pos+to+" "+gn, type: "mutation", to: to, range: range, info: "Based on "+origin};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }

    function glyco(elem) {
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");
      to2 = $(elem).attr("to2");
      wt2 = $(elem).attr("wt2");

      origin = $(elem).attr("motif");

      console.log(origin);

      range = new Array;
      range.push(pos);
      modi = {method: wt+pos+to + " Glycosylation", type: "mutation", to: to, range: range, info: "Based on "+origin};
      modifications.push(modi);

      if (to2) {
      range = new Array;
      pos2 = parseInt(parseInt(pos)+1)
      range.push(pos2);
      modi = {method: wt2+pos2+to2 + " Glycosylation", type: "mutation", to: to2, range: range, info: "Based on "+origin};
      modifications.push(modi);
      }

      overlay_modifications();
      modifications_overview();
    }

    function palmi(elem) {
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");

      origin = $(elem).attr("motif");

      console.log(origin);

      range = new Array;
      range.push(pos);
      modi = {method: wt+pos+to + " Palmitoylation site removal", type: "mutation", to: to, range: range, info: "Based on "+origin};
      modifications.push(modi);

      overlay_modifications();
      modifications_overview();
    }

    function modifications_overview() {

      $("#overview").html("");

      $.each(modifications, function(key,val) {

        type = val['type'];
        range = val['range'];
        method = val['method'];
        from = val['from'];

        if (val['info']) {
          info = "<p>"+val['info']+"</p>";
        } else {
          info = "";
        }

        row =  "<h3>"+method+" ("+type+")</h3>" +
            "<div>" +
            // "  <p>Based from "+from+"</p>" +
            // "  <p>"+range+"</p>" +
            info +
            "  <button onclick='remove_mod(this)' mod_id="+key+">Remove</button>" +
            "</div>"

        $("#overview").append(row);

      }) 
      $( "#overview" ).accordion( "refresh" );
      $( "#overview" ).accordion({
        collapsible: true,
        active: false,
      });

    }

    function remove_mod(elem) {
      id = $(elem).attr("mod_id");
      console.log('remove id'+id)
      //delete modifications[id];
      modifications.splice(id, 1);
      resetModifications();
      overlay_modifications();
      modifications_overview();

    }

    function overlay_modifications() {

      $.each(modifications, function(key,val) {

        type = val['type'];
        range = val['range'];
        console.log(key);

        $.each(range, function(i, ii){
          console.log(ii);
          color_residue(ii,type);

        })


      })

    }

    function color_residue(pos, type) {

     if (type == 'deletion') {
        bg = 'red';
        fill = 'white';
     } else if (type == 'mutation') {
        bg = 'yellow';
        fill = 'red';
     }

     $('#'+pos+'t').css("fill", fill);
     $('#'+pos+'t').prev().css("fill", bg);


    }

  // Make snake plot big
  $(document).ready(function() {

    $('input[type=radio][name=state], input[type=radio][name=fusionpos]').change(function() {
          build_nterm_menu();
          build_cterm_menu();
          build_icl3_menu();
    });

    $( "#overview" ).accordion({
      collapsible: true,
      active: false,
    });

        $( "#dialog" ).dialog({
      autoOpen: false,
      show: {
        effect: "blind",
        duration: 200
      },
      hide: {
        effect: "explode",
        duration: 200
      },
      buttons: {
        "Reset": function() {
          $( this ).dialog( "close" );
          resetAll();
        },
        Cancel: function() {
          $( this ).dialog( "close" );
        }
      }
    });



        $(".long").show();
        $(".short").hide();
        maxmin();

      // http://localhost:8000/construct/tool/json/nterm/adrb2_human/
      $.getJSON( "/construct/tool/json/nterm/{{target.entry_name}}/", function( data ) {
          n_term_data = data; 
          build_nterm_menu();
        });

      // http://localhost:8000/construct/tool/json/cterm/adrb2_human/
      $.getJSON( "/construct/tool/json/cterm/{{target.entry_name}}/", function( data ) {
          c_term_data = data;
          build_cterm_menu();
        });

      // http://localhost:8000/construct/tool/json/icl3/adrb2_human/
      $.getJSON( "/construct/tool/json/icl3/{{target.entry_name}}/", function( data ) {
          icl3_data = data; 
          build_icl3_menu();
        });


      $.getJSON( "/construct/tool/json/glyco/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( type, val ) {
            temp = "<li id='" + type + "' class=\"dropdown-submenu\"><a>" + type + " ("+Object.keys(val).length+" hits)</a><ul class=\"dropdown-menu\">";
            $.each( val, function( key, value ) {
                if (type == 'mammalian') {
                temp += "<li id='"+key+"'  class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" & "+value[4][1]+parseInt(value[0]+1)+value[3]+" ("+value[5]+")</a><ul  class=\"dropdown-menu\"><li><a onclick='glyco(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' to2='"+value[3]+"' wt2='"+value[4][1]+"'> Mutate "+value[4][0]+value[0]+value[1]+" & "+value[4][1]+parseInt(value[0]+1)+value[3]+"</a></li></ul></li>";
                } else {
                temp += "<li id='"+key+"' class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" ("+value[5]+")</a><ul class=\"dropdown-menu\"><li><a onclick='glyco(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' > Mutate "+value[4][0]+value[0]+value[1]+"</a></li></ul></li>";
                }
            });

            temp += "</ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#glyco").html(result);
          removals_list["glyco"] = data;
          build_site_removals();
        });
                    
      // http://localhost:8000/construct/tool/json/palmi/adrb2_human/
      $.getJSON( "/construct/tool/json/palmi/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( type, val ) {
            temp = "";
            $.each( val, function( key, value ) {
                temp += "<li id='"+key+"' class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" ("+value[5]+")</a><ul class=\"dropdown-menu\"><li><a onclick='palmi(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' > Mutate "+value[4][0]+value[0]+value[1]+"</a></li></ul></li>";
            });

            temp += "</ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#palmi").html(result);
          removals_list["palmi"] = data;
          build_site_removals();
        });

        $.getJSON( "/construct/tool/json/cons_strucs/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_strucs").html(result);
          mutations_browser['cons_strucs'] = data;
          build_mutations();
        });

        $.getJSON( "/construct/tool/json/cons_rf/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_rf").html(result);
          mutations_browser['cons_rf'] = data;
          build_mutations();
        });

        $.getJSON( "/construct/tool/json/cons_rf_and_class/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_rf_and_class").html(result);
          mutations_browser['cons_rf_and_class'] = data;
          build_mutations();
        });


        

        $.getJSON( "/construct/tool/json/cons_rm_GP/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_rm_GP").html(result);
          mutations_browser['cons_rm_GP'] = data;
          build_mutations();
        });

      $.getJSON( "/construct/tool/json/termo/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( level, gns ) {
            if (level == 1) {
              level_text = "From target recepter"
            } else if (level == 2) {
              level_text = "Common mutation (Mut)"
            } else if (level == 3) {
              level_text = "Common mutation (Wt)"
            }
            mutations_browser['termo_'+level_text] = gns;
            temp = "<li id='" + level + "' class=\"dropdown-submenu\"><a>" + level_text + "</a><ul class=\"dropdown-menu\">";
            $.each( gns, function( gn, aa ) {
                $.each( aa, function( key, value ) {

                extra = " to ";
                to = key ; 
                number = value['pdbs'].length;
                if (level == 2) {
                  extra = " to ";
                  from = value['wt'][0];
                  to = key;
                  number = value['proteins'].length;
                } else if (level ==3 ){
                  extra = " to " + value['muts'] + " from ";
                  to = value['muts'];
                  number = value['proteins'].length;
                }

                temp += "<li id='" + level + "' class=\"dropdown-submenu\"><a>" + gn + extra + " ("+number+" hits)</a><ul class=\"dropdown-menu\">";
                temp += "<li><a>"+gn+" in {{target.entry_name}} is "+value['wt'][0]+"</a></li>";
                temp += "<li class=\"divider\"></li>";

                // pos = to.split(",");
                if (level == 3) {
                  $.each(to, function(key,pos){
                    temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+pos+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+pos+"</strong></a></li>";
                  })
                } else {
                  temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+to+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+to+"</strong></a></li>";
                }
                temp += "<li class=\"divider\"></li>";
                if (level == 1 ) {
                  $.each(value['pdbs'], function(i, pdb) {
                      temp += "<li id='" + level + "'><a>" + pdb+"</a>";
                  })
                } else if (level == 2 || level == 3 ) {
                  $.each(value['proteins'], function(i, pdb) {
                      temp += "<li id='" + level + "'><a>" + pdb+"</a>";
                  })
                }
                // temp += "<li id='" + level + "' class=\"dropdown-submenu\"><a>" + key + " ("+value['hits']+" hits)</a>";
                // temp += "<ul class=\"dropdown-menu\"><li></li></ul>";

                temp += "</li>";
                temp += "</ul></li>";
                });
             });
            temp += "</ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#thermo").html(result);
        });
          build_mutations();

    });
</script>
{% endblock %}

